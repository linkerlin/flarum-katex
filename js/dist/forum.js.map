{"version":3,"file":"forum.js","mappings":"MACA,IAAIA,EAAsB,CCA1BA,EAAyBC,IACxB,IAAIC,EAASD,GAAUA,EAAOE,WAC7B,IAAOF,EAAiB,QACxB,IAAM,EAEP,OADAD,EAAoBI,EAAEF,EAAQ,CAAEG,EAAGH,IAC5BA,GCLRF,EAAwB,CAACM,EAASC,KACjC,IAAI,IAAIC,KAAOD,EACXP,EAAoBS,EAAEF,EAAYC,KAASR,EAAoBS,EAAEH,EAASE,IAC5EE,OAAOC,eAAeL,EAASE,EAAK,CAAEI,YAAY,EAAMC,IAAKN,EAAWC,MCJ3ER,EAAwB,CAACc,EAAKC,IAAUL,OAAOM,UAAUC,eAAeC,KAAKJ,EAAKC,I,mBCAlF,MAAM,EAA+BI,OAAOC,KAAKC,OAAO,iBCAlD,EAA+BF,OAAOC,KAAKC,OAAO,c,aCAxD,MAAM,EAA+BF,OAAOC,KAAKC,OAAO,0B,aCAxD,MAAM,EAA+BF,OAAOC,KAAKC,OAAO,gC,aCAxD,MAAM,EAA+BF,OAAOC,KAAKC,OAAO,iC,aCMxDC,IAAAA,aAAiBC,IAAI,kBAAmB,WAEtC,IAAMC,EAAWF,IAAAA,MAAUG,UAAU,uBACrC,GAAID,IAAaE,SAASC,cAAc,cAAcH,EAAQ,MAAO,CACnE,IAAMI,EAAOF,SAASG,cAAc,QACpCD,EAAKE,IAAM,aACXF,EAAKG,KAAOP,EACZE,SAASM,KAAKC,YAAYL,EAC5B,CAGA,GAAIN,IAAAA,MAAUG,UAAU,yBAA0B,CAChD,IAAMS,EAAaZ,IAAAA,MAAUG,UAAU,sBACvC,GAAIS,IAAeR,SAASC,cAAc,eAAeO,EAAU,MAAO,CACxE,IAAMC,EAAST,SAASG,cAAc,UACtCM,EAAOC,IAAMF,EACbC,EAAOE,OAAQ,EACfF,EAAOG,YAAc,YACrBZ,SAASM,KAAKC,YAAYE,EAC5B,CACF,CAGA,IAAMI,EAAoB,SAACC,GACzB,IAAMC,EAAcnB,IAAAA,MAAUG,UAAU,2BAClCiB,EAAapB,IAAAA,MAAUG,UAAU,0BACjCkB,EAAgBrB,IAAAA,MAAUG,UAAU,kCACpCmB,EAAetB,IAAAA,MAAUG,UAAU,iCAEzC,IAAKe,EAAM,OAAOA,EAGlB,GAAIC,GAAeE,EAAe,CAChC,IAEME,EAFgBJ,EAAYK,QAAQ,MAAO,gBAG9CA,QAAQ,QAAS,QACjBA,QAAQ,MAAO,OACfA,QAAQ,MAAO,OACfA,QAAQ,MAAO,OACZC,EAAc,IAAIC,OAAOH,EAAgB,KACzCI,EAAoBN,EAAcG,QAAQ,MAAO,MACvDN,EAAOA,EAAKM,QAAQC,EAAaE,EACnC,CAGA,GAAIP,GAAcE,EAAc,CAC9B,IAEMC,EAFeH,EAAWI,QAAQ,MAAO,gBAEXA,QAAQ,MAAO,OAC7CI,EAAa,IAAIF,OAAOH,EAAgB,KACxCM,EAAmBP,EAAaE,QAAQ,MAAO,MACrDN,EAAOA,EAAKM,QAAQI,EAAYC,EAClC,CAEA,OAAOX,CACT,GAuCAY,EAAAA,EAAAA,QAAOC,IAAAA,UAAsB,WAAY,SAAUC,GACjD,IAAMC,EAAWD,EAAME,IAAI7B,cAAc,YACrC4B,GAAYA,EAASE,QACvBF,EAASE,MAvCa,SAACjB,GACzB,IAAMC,EAAcnB,IAAAA,MAAUG,UAAU,2BAClCiB,EAAapB,IAAAA,MAAUG,UAAU,0BACjCkB,EAAgBrB,IAAAA,MAAUG,UAAU,kCACpCmB,EAAetB,IAAAA,MAAUG,UAAU,iCAEzC,IAAKe,EAAM,OAAOA,EAGlB,GAAIG,GAAiBF,EAAa,CAChC,IAEMI,EAFkBF,EAAcG,QAAQ,MAAO,gBAGlDA,QAAQ,MAAO,OACfA,QAAQ,MAAO,OACZY,EAAgB,IAAIV,OAAOH,EAAgB,KAC3CI,EAAoBR,EAAYK,QAAQ,MAAO,MACrDN,EAAOA,EAAKM,QAAQY,EAAeT,EACrC,CAGA,GAAIL,GAAgBF,EAAY,CAC9B,IAEMG,EAFiBD,EAAaE,QAAQ,MAAO,gBAGhDA,QAAQ,MAAO,OACfA,QAAQ,MAAO,OACZa,EAAe,IAAIX,OAAOH,EAAgB,KAC1CM,EAAmBT,EAAWI,QAAQ,MAAO,MACnDN,EAAOA,EAAKM,QAAQa,EAAcR,EACpC,CAEA,OAAOX,CACT,CAMqBoB,CAAkBL,EAASE,OAEhD,IAGAL,EAAAA,EAAAA,QAAOS,IAAAA,UAAwB,WAAY,WACzC,IAAMC,EAAUC,KAAKC,SAASC,OAAOH,UACjCA,GACFC,KAAKC,SAASC,OAAOH,QAAQvB,EAAkBuB,GAEnD,GAGmB,oBAARI,KAAuBA,IAAIC,gBACpCC,EAAAA,EAAAA,UAASF,IAAIC,cAAe,UAAW,SAAUE,EAAU7B,EAAM8B,GAE/DD,EADsB9B,EAAkBC,GAChB8B,EAC1B,GAIF,IAAMC,EAAa,WACI,oBAAVC,QAGX9C,SAAS+C,iBAAiB,iBAAiBC,QAAQ,SAACJ,GAClD,IAAKA,EAAQK,aAAa,uBACxB,IACE,IAAMC,EAAUC,KAAKC,MAAMR,EAAQS,aAAa,uBAAyB,MACzEP,MAAMQ,OAAOV,EAAQW,YAAaX,EAASM,GAC3CN,EAAQY,aAAa,sBAAuB,OAC9C,CAAE,MAAOC,GACPC,QAAQC,MAAM,gCAAiCF,EACjD,CAEJ,GAGAzD,SAAS+C,iBAAiB,gBAAgBC,QAAQ,SAACJ,GACjD,IAAKA,EAAQK,aAAa,uBACxB,IACE,IAAMC,EAAUC,KAAKC,MAAMR,EAAQS,aAAa,uBAAyB,MACzEP,MAAMQ,OAAOV,EAAQW,YAAaX,EAASM,GAC3CN,EAAQY,aAAa,sBAAuB,OAC9C,CAAE,MAAOC,GACPC,QAAQC,MAAM,+BAAgCF,EAChD,CAEJ,GACF,GAGA/B,EAAAA,EAAAA,QAAOkC,IAAAA,UAAgB,CAAC,WAAY,YAAaf,GAGjD,IAAMgB,EAAUjE,IAAAA,MAAUG,UAAU,sBACpC,GAAI8D,GAA4B,oBAAVf,MAAuB,CAC3C,IAAMrC,EAAST,SAASG,cAAc,UACtCM,EAAOC,IAAMmD,EACbpD,EAAOE,OAAQ,EACfF,EAAOG,YAAc,YACrBH,EAAOqD,OAASjB,EAChB7C,SAASM,KAAKC,YAAYE,EAC5B,KAA4B,oBAAVqC,OAChBD,GAEJ,E","sources":["webpack://@linkerlin/flarum-katex/webpack/bootstrap","webpack://@linkerlin/flarum-katex/webpack/runtime/compat get default export","webpack://@linkerlin/flarum-katex/webpack/runtime/define property getters","webpack://@linkerlin/flarum-katex/webpack/runtime/hasOwnProperty shorthand","webpack://@linkerlin/flarum-katex/external root \"flarum.core.compat['common/extend']\"","webpack://@linkerlin/flarum-katex/external root \"flarum.core.compat['common/app']\"","webpack://@linkerlin/flarum-katex/external root \"flarum.core.compat['common/components/Page']\"","webpack://@linkerlin/flarum-katex/external root \"flarum.core.compat['common/components/TextEditor']\"","webpack://@linkerlin/flarum-katex/external root \"flarum.core.compat['forum/components/ComposerBody']\"","webpack://@linkerlin/flarum-katex/./src/forum/index.js"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Page'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/TextEditor'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/ComposerBody'];","import { extend, override } from 'flarum/common/extend';\nimport app from 'flarum/common/app';\nimport Page from 'flarum/common/components/Page';\nimport TextEditor from 'flarum/common/components/TextEditor';\nimport ComposerBody from 'flarum/forum/components/ComposerBody';\n\napp.initializers.add('linkerlin-katex', () => {\n  // Load KaTeX CSS\n  const katexCss = app.forum.attribute('katex.cdn_katex_css');\n  if (katexCss && !document.querySelector(`link[href=\"${katexCss}\"]`)) {\n    const link = document.createElement('link');\n    link.rel = 'stylesheet';\n    link.href = katexCss;\n    document.head.appendChild(link);\n  }\n\n  // Load copy-tex if enabled\n  if (app.forum.attribute('katex.enable_copy_tex')) {\n    const copyTexUrl = app.forum.attribute('katex.cdn_copy_tex');\n    if (copyTexUrl && !document.querySelector(`script[src=\"${copyTexUrl}\"]`)) {\n      const script = document.createElement('script');\n      script.src = copyTexUrl;\n      script.defer = true;\n      script.crossOrigin = 'anonymous';\n      document.head.appendChild(script);\n    }\n  }\n\n  // Replace LaTeX delimiters with BBCode delimiters for processing\n  const replaceDelimiters = (text) => {\n    const inlineDelim = app.forum.attribute('katex.inline_delimiters');\n    const blockDelim = app.forum.attribute('katex.block_delimiters');\n    const bbInlineDelim = app.forum.attribute('katex.bbcode_inline_delimiters');\n    const bbBlockDelim = app.forum.attribute('katex.bbcode_block_delimiters');\n\n    if (!text) return text;\n\n    // Replace inline delimiters \\\\( ... \\\\) with [imath]...[/imath]\n    if (inlineDelim && bbInlineDelim) {\n      const inlinePattern = inlineDelim.replace('%e%', '([\\\\s\\\\S]*?)');\n      // Escape special regex characters but handle \\\\( and \\\\) properly\n      const escapedPattern = inlinePattern\n        .replace(/\\\\\\\\/g, '\\\\\\\\')\n        .replace(/\\(/g, '\\\\(')\n        .replace(/\\)/g, '\\\\)')\n        .replace(/\\$/g, '\\\\$');\n      const inlineRegex = new RegExp(escapedPattern, 'g');\n      const inlineReplacement = bbInlineDelim.replace('%e%', '$1');\n      text = text.replace(inlineRegex, inlineReplacement);\n    }\n\n    // Replace block delimiters $$ ... $$ with [math]...[/math]\n    if (blockDelim && bbBlockDelim) {\n      const blockPattern = blockDelim.replace('%e%', '([\\\\s\\\\S]*?)');\n      // Escape special regex characters\n      const escapedPattern = blockPattern.replace(/\\$/g, '\\\\$');\n      const blockRegex = new RegExp(escapedPattern, 'g');\n      const blockReplacement = bbBlockDelim.replace('%e%', '$1');\n      text = text.replace(blockRegex, blockReplacement);\n    }\n\n    return text;\n  };\n\n  // Replace BBCode delimiters with LaTeX delimiters for display\n  const restoreDelimiters = (text) => {\n    const inlineDelim = app.forum.attribute('katex.inline_delimiters');\n    const blockDelim = app.forum.attribute('katex.block_delimiters');\n    const bbInlineDelim = app.forum.attribute('katex.bbcode_inline_delimiters');\n    const bbBlockDelim = app.forum.attribute('katex.bbcode_block_delimiters');\n\n    if (!text) return text;\n\n    // Replace [imath]...[/imath] with \\\\( ... \\\\)\n    if (bbInlineDelim && inlineDelim) {\n      const bbInlinePattern = bbInlineDelim.replace('%e%', '([\\\\s\\\\S]*?)');\n      // Escape BBCode brackets\n      const escapedPattern = bbInlinePattern\n        .replace(/\\[/g, '\\\\[')\n        .replace(/\\]/g, '\\\\]');\n      const bbInlineRegex = new RegExp(escapedPattern, 'g');\n      const inlineReplacement = inlineDelim.replace('%e%', '$1');\n      text = text.replace(bbInlineRegex, inlineReplacement);\n    }\n\n    // Replace [math]...[/math] with $$ ... $$\n    if (bbBlockDelim && blockDelim) {\n      const bbBlockPattern = bbBlockDelim.replace('%e%', '([\\\\s\\\\S]*?)');\n      // Escape BBCode brackets\n      const escapedPattern = bbBlockPattern\n        .replace(/\\[/g, '\\\\[')\n        .replace(/\\]/g, '\\\\]');\n      const bbBlockRegex = new RegExp(escapedPattern, 'g');\n      const blockReplacement = blockDelim.replace('%e%', '$1');\n      text = text.replace(bbBlockRegex, blockReplacement);\n    }\n\n    return text;\n  };\n\n  // Handle text editor content\n  extend(TextEditor.prototype, 'oncreate', function (vnode) {\n    const textarea = vnode.dom.querySelector('textarea');\n    if (textarea && textarea.value) {\n      textarea.value = restoreDelimiters(textarea.value);\n    }\n  });\n\n  // Handle composer submission\n  extend(ComposerBody.prototype, 'onsubmit', function () {\n    const content = this.composer.fields.content();\n    if (content) {\n      this.composer.fields.content(replaceDelimiters(content));\n    }\n  });\n\n  // Handle preview mode\n  if (typeof s9e !== 'undefined' && s9e.TextFormatter) {\n    override(s9e.TextFormatter, 'preview', function (original, text, element) {\n      const processedText = replaceDelimiters(text);\n      original(processedText, element);\n    });\n  }\n\n  // Render math on page load and updates\n  const renderMath = () => {\n    if (typeof katex === 'undefined') return;\n\n    // Render inline math\n    document.querySelectorAll('.katex-inline').forEach((element) => {\n      if (!element.hasAttribute('data-katex-rendered')) {\n        try {\n          const options = JSON.parse(element.getAttribute('data-katex-options') || '{}');\n          katex.render(element.textContent, element, options);\n          element.setAttribute('data-katex-rendered', 'true');\n        } catch (e) {\n          console.error('KaTeX inline rendering error:', e);\n        }\n      }\n    });\n\n    // Render block math\n    document.querySelectorAll('.katex-block').forEach((element) => {\n      if (!element.hasAttribute('data-katex-rendered')) {\n        try {\n          const options = JSON.parse(element.getAttribute('data-katex-options') || '{}');\n          katex.render(element.textContent, element, options);\n          element.setAttribute('data-katex-rendered', 'true');\n        } catch (e) {\n          console.error('KaTeX block rendering error:', e);\n        }\n      }\n    });\n  };\n\n  // Render math when page loads or updates\n  extend(Page.prototype, ['oncreate', 'onupdate'], renderMath);\n\n  // Load KaTeX library\n  const katexJs = app.forum.attribute('katex.cdn_katex_js');\n  if (katexJs && typeof katex === 'undefined') {\n    const script = document.createElement('script');\n    script.src = katexJs;\n    script.defer = true;\n    script.crossOrigin = 'anonymous';\n    script.onload = renderMath;\n    document.head.appendChild(script);\n  } else if (typeof katex !== 'undefined') {\n    renderMath();\n  }\n});"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","app","add","katexCss","attribute","document","querySelector","link","createElement","rel","href","head","appendChild","copyTexUrl","script","src","defer","crossOrigin","replaceDelimiters","text","inlineDelim","blockDelim","bbInlineDelim","bbBlockDelim","escapedPattern","replace","inlineRegex","RegExp","inlineReplacement","blockRegex","blockReplacement","extend","TextEditor","vnode","textarea","dom","value","bbInlineRegex","bbBlockRegex","restoreDelimiters","ComposerBody","content","this","composer","fields","s9e","TextFormatter","override","original","element","renderMath","katex","querySelectorAll","forEach","hasAttribute","options","JSON","parse","getAttribute","render","textContent","setAttribute","e","console","error","Page","katexJs","onload"],"sourceRoot":""}